# 3x-ui Agent Configuration
# Copy this file to .env and customize for your environment

# =============================================================================
# Server Settings
# =============================================================================

# Address and port the agent API listens on
# Default: 0.0.0.0:2054
AGENT_LISTEN_ADDR=0.0.0.0:2054

# Unique identifier for this agent server
# Used by controller to track this specific agent
# Example: agent-01, prod-ny-1, eu-gateway-london
AGENT_SERVER_ID=agent-01

# Human-readable name for this agent
# Shown in UI and logs
AGENT_SERVER_NAME=Production Agent 01

# Comma-separated tags for grouping/filtering agents
# Example: production,us-east,high-capacity
AGENT_TAGS=production,primary

# =============================================================================
# Controller Settings (Optional - for agent health reporting)
# =============================================================================

# Controller endpoint for agent to report health/metrics (if enabled)
# Leave empty to disable health reporting to controller
# Example: https://controller.example.com:2053
AGENT_CONTROLLER_ENDPOINT=

# =============================================================================
# Authentication Configuration
# =============================================================================

# Authentication type: "mtls" or "jwt"
# PRODUCTION RECOMMENDED: mtls
# mtls = Mutual TLS with client certificates (most secure)
# jwt  = JWT Bearer token (simpler but less secure)
AGENT_AUTH_TYPE=mtls

# --- mTLS Configuration (when AGENT_AUTH_TYPE=mtls) ---

# Path to agent server certificate (PEM format)
# Generated with: scripts/certs/gen-agent-cert.sh
AGENT_CERT_FILE=/etc/x-ui-agent/certs/agent.crt

# Path to agent server private key (PEM format)
# KEEP THIS FILE SECURE with chmod 600
AGENT_KEY_FILE=/etc/x-ui-agent/certs/agent.key

# Path to CA certificate for verifying controller client certificates
# Same CA used to sign both agent and controller certificates
AGENT_CA_FILE=/etc/x-ui-agent/certs/ca.crt

# --- JWT Configuration (when AGENT_AUTH_TYPE=jwt) ---
# NOT RECOMMENDED for production - use mTLS instead

# Static JWT secret token
# Controller must send this in Authorization: Bearer <token> header
# Generate with: openssl rand -hex 32
# AGENT_JWT_SECRET=your-secret-token-here

# =============================================================================
# Xray Settings
# =============================================================================

# Path to Xray binary folder
# Default: /usr/local/x-ui/bin
XRAY_BIN_FOLDER=/usr/local/x-ui/bin

# Path to Xray configuration folder
# Default: /etc/x-ui
XRAY_CONFIG_FOLDER=/etc/x-ui

# =============================================================================
# Logging
# =============================================================================

# Log level: debug, info, warning, error
# Default: info
AGENT_LOG_LEVEL=info

# Path to log file
# Use stdout for container deployments
# Default: /var/log/x-ui-agent/agent.log
AGENT_LOG_FILE=/var/log/x-ui-agent/agent.log

# =============================================================================
# Performance Tuning
# =============================================================================

# Maximum concurrent requests the agent will handle
# Default: 50
AGENT_MAX_CONCURRENT=50

# Request timeout in seconds
# Default: 30
AGENT_REQUEST_TIMEOUT=30

# Rate limit: maximum requests per minute per IP
# Default: 100
# Set to 0 to disable rate limiting
AGENT_RATE_LIMIT=100

# =============================================================================
# Security Notes
# =============================================================================

# 1. ALWAYS use mTLS in production (AGENT_AUTH_TYPE=mtls)
# 2. Keep private keys (*.key files) secure with chmod 600
# 3. Never commit this file with real secrets to version control
# 4. Rotate certificates before expiration (default: 1 year)
# 5. Use firewall rules to restrict access to port 2054
# 6. Monitor logs for authentication failures
# 7. Keep agent binary and dependencies updated

# =============================================================================
# Quick Setup for mTLS
# =============================================================================

# 1. Generate certificates (on secure workstation):
#    cd scripts/certs
#    ./gen-ca.sh                          # Generate CA (once)
#    ./gen-agent-cert.sh agent-01         # Generate agent cert
#
# 2. Deploy certificates to agent server:
#    mkdir -p /etc/x-ui-agent/certs
#    scp ca.crt agent-01.crt agent-01.key user@agent:/tmp/
#    sudo mv /tmp/agent-01.crt /etc/x-ui-agent/certs/agent.crt
#    sudo mv /tmp/agent-01.key /etc/x-ui-agent/certs/agent.key
#    sudo mv /tmp/ca.crt /etc/x-ui-agent/certs/ca.crt
#    sudo chmod 600 /etc/x-ui-agent/certs/agent.key
#    sudo chmod 644 /etc/x-ui-agent/certs/*.crt
#
# 3. Copy this file and set variables:
#    cp deploy/agent/agent.env.example /etc/x-ui-agent/.env
#    nano /etc/x-ui-agent/.env
#
# 4. Start agent:
#    source /etc/x-ui-agent/.env
#    x-ui agent
