# 3x-ui Controller Configuration (Multi-Server Support)
# Copy this file to .env and customize for your environment

# =============================================================================
# Controller Settings
# =============================================================================

# NOTE: Most controller settings are configured through the web UI
# This file documents environment variables for special configurations

# =============================================================================
# mTLS Client Certificate Paths (for Remote Agent Connections)
# =============================================================================

# These paths are used by default when adding remote agents with mTLS
# Individual agents can override these in their server configuration

# Default controller client certificate (PEM format)
# Generated with: scripts/certs/gen-controller-cert.sh
# Used when controller connects to remote agents
CONTROLLER_CERT_FILE=/etc/x-ui/certs/controller.crt

# Default controller client private key (PEM format)
# KEEP THIS FILE SECURE with chmod 600
CONTROLLER_KEY_FILE=/etc/x-ui/certs/controller.key

# Default CA certificate for verifying agent server certificates
# Same CA used to sign both agent and controller certificates
CONTROLLER_CA_FILE=/etc/x-ui/certs/ca.crt

# =============================================================================
# Remote Agent Configuration
# =============================================================================

# When adding a remote agent in the UI, use these settings:
#
# For mTLS Authentication (RECOMMENDED):
# --------------------------------------
# Auth Type: mtls
# Auth Data (JSON):
# {
#   "certFile": "/etc/x-ui/certs/controller.crt",
#   "keyFile": "/etc/x-ui/certs/controller.key",
#   "caFile": "/etc/x-ui/certs/ca.crt"
# }
#
# For JWT Authentication (NOT RECOMMENDED):
# ----------------------------------------
# Auth Type: jwt
# Auth Data (JSON):
# {
#   "token": "your-secret-token-here"
# }
# OR just the token directly:
# Auth Data: your-secret-token-here

# =============================================================================
# Performance Settings
# =============================================================================

# Maximum concurrent health checks for remote agents
# Prevents resource exhaustion when monitoring many agents
# Default: 10
# HEALTH_MAX_CONCURRENCY=10

# Health check interval in seconds
# How often to check agent status
# Default: 30
# HEALTH_CHECK_INTERVAL=30

# Health check timeout in seconds
# Maximum time to wait for agent response
# Default: 10
# HEALTH_CHECK_TIMEOUT=10

# =============================================================================
# Database Settings
# =============================================================================

# Database path
# Default: /etc/x-ui/x-ui.db
# DB_PATH=/etc/x-ui/x-ui.db

# =============================================================================
# Security Notes
# =============================================================================

# 1. ALWAYS use mTLS for remote agent connections in production
# 2. Keep controller private key secure with chmod 600
# 3. Never commit this file with real secrets to version control
# 4. Rotate certificates before expiration (default: 1 year)
# 5. Restrict access to controller web UI (use nginx/firewall)
# 6. Enable HTTPS for web UI (separate from agent mTLS)
# 7. Use strong passwords for web UI users
# 8. Monitor failed authentication attempts
# 9. Backup database regularly
# 10. Keep controller and agents on same version

# =============================================================================
# Quick Setup for mTLS
# =============================================================================

# 1. Generate certificates (on secure workstation):
#    cd scripts/certs
#    ./gen-ca.sh                              # Generate CA (once)
#    ./gen-controller-cert.sh                 # Generate controller cert
#    ./gen-agent-cert.sh agent-01             # Generate agent cert (per agent)
#
# 2. Deploy controller certificates:
#    mkdir -p /etc/x-ui/certs
#    sudo cp controller.crt controller.key ca.crt /etc/x-ui/certs/
#    sudo chmod 600 /etc/x-ui/certs/controller.key
#    sudo chmod 644 /etc/x-ui/certs/*.crt
#
# 3. Deploy agent certificates to each agent server:
#    # See deploy/agent/agent.env.example for agent setup
#
# 4. In 3x-ui web UI, add remote server:
#    - Navigate to: Servers Management
#    - Click: Add Server
#    - Name: Production Agent 01
#    - Endpoint: https://agent-server:2054
#    - Auth Type: mTLS
#    - Auth Data: {"certFile":"/etc/x-ui/certs/controller.crt","keyFile":"/etc/x-ui/certs/controller.key","caFile":"/etc/x-ui/certs/ca.crt"}
#    - Tags: production,us-east (optional)
#    - Save
#
# 5. Verify connection:
#    - Server status should show "online" with green indicator
#    - Check controller logs for successful mTLS handshake
#    - Check agent logs for "Client authenticated via mTLS: CN=3x-ui-controller"

# =============================================================================
# Troubleshooting
# =============================================================================

# Connection Issues:
# -----------------
# 1. Verify agent is running and listening on correct port
# 2. Check firewall allows connections on port 2054
# 3. Verify certificates are valid and not expired:
#    openssl x509 -in /etc/x-ui/certs/controller.crt -noout -dates
# 4. Test mTLS connection manually:
#    curl --cert /etc/x-ui/certs/controller.crt \
#         --key /etc/x-ui/certs/controller.key \
#         --cacert /etc/x-ui/certs/ca.crt \
#         https://agent-server:2054/api/v1/health
#
# Certificate Errors:
# ------------------
# 1. "certificate signed by unknown authority"
#    - Ensure ca.crt is the SAME file on controller and agent
#    - Verify all certs were signed by the same CA
# 2. "tls: bad certificate"
#    - Check cert/key pair match
#    - Verify controller cert has "clientAuth" in extendedKeyUsage
# 3. "x509: certificate has expired"
#    - Regenerate certificates and redeploy
#
# Performance Issues:
# ------------------
# 1. Many agents timing out
#    - Increase HEALTH_MAX_CONCURRENCY
#    - Increase HEALTH_CHECK_TIMEOUT
#    - Check network latency to agents
# 2. High memory usage
#    - Reduce HEALTH_CHECK_INTERVAL for less frequent checks
#    - Check for connection leaks in logs

# =============================================================================
# Example Multi-Region Deployment
# =============================================================================

# Controller (Central - US):
# - controller.example.com
# - Manages all agents
# - Has controller.crt/controller.key for mTLS client auth
#
# Agent 1 (US East):
# - us-east-1.example.com:2054
# - Tags: production,us-east,primary
# - Has agent-us-east-1.crt/agent-us-east-1.key
#
# Agent 2 (EU West):
# - eu-west-1.example.com:2054
# - Tags: production,eu-west,primary
# - Has agent-eu-west-1.crt/agent-eu-west-1.key
#
# Agent 3 (Asia Pacific):
# - ap-south-1.example.com:2054
# - Tags: production,asia,secondary
# - Has agent-ap-south-1.crt/agent-ap-south-1.key
#
# All use same CA for mTLS, different individual certificates
